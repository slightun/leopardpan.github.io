# 战斗系统分享
> by 张晓光, at 2017-11-17

****
## 目录
* [1. 战斗流程]()
* [2. 战斗计算过程]()
* [3. 战斗计算要点]()
* [4. 战斗异常解决]()
* [5. 战斗统计]()
* [6. 战斗自动化测试]()
* [其他分享]()

___


### 1. 战斗流程
- ** 1.1 客户端驱动战斗**
    - *客户端发送请求战斗协议*
      > req_create_battle(int battleid, int battletype);//请求创建战斗，上传战斗编号，以及战斗类型
        - 服务器收到请求战斗时，创建战斗对象，进行战斗初始化工作，在做完战斗开始处理后，通知客户端进入战斗
        > res_create_battel(int battleuid, battle_info info, int state);//返回一场战斗相关信息,只有返回state 为0时，创建成功

    - *客户端收到开始战斗协议*
        - 客户端创建战斗，并请求随机数
          > req_random_num(int battleuid, int start, int numbers);//请求战斗中使用随机数
            - 服务器下发随机数
              > res_random_num(int battleuid, int start , int numbers, list<int> randomList);//返回随机数信息
        - 客户端收到随机数后，开始战斗过程的自行计算
        - 客户端计算每一小回合后，上报数据
          > req_battle_process(int battleuid,battle_data data, list<battle_actor_attr> ldata);
            - 服务器收到上报数据后，会进行此次小回合的计算，计算完成后进行校验
                - [战斗异常时，若是服务器是win32环境，会直接将客户端弹出战斗，提示战斗异常]

    - *客户端计算完战斗过程后 / 客户端跳过战斗，发送请求结束战斗协议，等待服务器战斗结果*
      > req_battle_over(bt7_result_info info, sec_battle_finish_log log);  //战斗结束，上报战斗结果  log：上报的日志
        - 服务器收到请求战斗结束协议后
            - 若服务器未计算完战斗，则继续计算
            - 计算完战斗后，根据校验情况修正战斗结果
                - 若校验失败次数低于阀值，则使用服务器战斗结果，修正结果下发客户端
                - 若校验失败次数高于阀值，则增加玩家每日异常计数
                    - 注意：玩家异常战斗计数超过阀值后，会被封号

- ** 1.2 服务器驱动战斗**
    - *服务器计算完战斗后，下发开始战斗协议、下发随机数。开始战斗协议battle_info结构包含每次出手的修正信息。*
      > res_create_battel(int battleuid, battle_info info, int state);//返回一场战斗相关信息,只有返回state 为0时，创建成功  
      > req_random_num(int battleuid, int start, int numbers);//请求战斗中使用随机数

    - *客户端收到开始战斗协议及随机数后*
        - 客户端自行计算战斗过程，但每次小回合计算完成后会进行数据修正

- ** 1.3 1v1战斗**
    - *服务器计算完战斗后，下发整个战斗过程的数据*
      > res_battle_team_info(pvp_battle_base_info info);
    - *客户端收到战斗数据后*
        - 客户端不会计算战斗过程，而只做战斗数据的表现
___

### 2. 战斗计算过程
- **2.1 战斗开始 / 切波之后**
    - 战前事件
    - 开场 buff
    - 检查替补上场
- **2.2 每次出手计算**
    - 检查替补上场
    - buff 结算点2：出手前
    - 常驻 buff
    - 确定主攻击者、技能攻击类型，优先顺序如下
        - 检查是否有角色可以释放必杀
        - 检查宠物是否可释放技能
        - 根据出手位确定主攻击者    
    - 若主攻击者不存在，或处于不可出手状态
        - buff 结算点4、5：攻击后
    - 若主攻击者存在，并且可出手
        - AI 处理
        - 确定攻击者列表
            - 确定协助者列表
        - 确定防御者列表
            - 确定主防御者
            - 根据主攻击者技能选址，确定防御者列表
            - 特殊处理致命信标、嘲讽、集火，可能会修改防御者列表
        - 攻击过程计算
            - 见下章节说明
        - 攻击后处理
            - 攻击后生效 buff：生效点5
            - 攻击后生效 buff：生效点1
            - 攻击扣血
                - 分段扣血
                - 其他扣血及特殊逻辑
            - 攻击后生效 buff：生效点2
            - 攻击后怒气处理
            - 攻击后 buff 处理
                - 若攻击类型为必杀
                    - buff 结算点10：必杀结算点
                - 其他攻击类型
                    - 受击方、攻击方进行buff减回合处理
                    - buff 结算点4、5、9、11：攻击后结算点
    - 神将流程
- **2.3 大回合结算**
    - 在客户端驱动战斗时，服务器在收到上报时先检查大回合结束
    - 在服务器驱动战斗时，服务器在每次出手后检查大回合结束即可
- **2.3 切波处理**
___

### 3. 战斗计算要点
- ***3.1 攻击过程计算***
  > 每一个攻击者对每一个防御者都进行一对一的攻击计算  
    比如1个攻击者，3个防御者。那么会一对一计算3次，共产生3条攻击信息  
    - **攻击信息的理解：**
        - 一对一的攻击计算
            - 主要包含技能 buff 的处理、伤害计算两部分
        - 计算完成后记录哪些内容
            - 攻防两方角色、原始伤害、融合伤害、真实物魔伤害、反弹伤害、神圣伤害等信息
    - **技能 buff 的处理**
        - 根据技能表 buff 列表、buff 随机规则，确定可触发哪些 buff
        - buff 触发
            - 读技能表的 buff 选址，确定 buff 触发给哪些角色
            - buff触发时
                - 读 buff 表的buff自身选址，确定此 buff 具体添加给哪些角色
        - buff 添加给具体角色
            - 根据 buff 生效类型（立即生效、攻击后生效、结算后生效），具体处理

    - **伤害计算**
        - 这个可具体参考代码，每一步伤害计算都做了注释

- ***3.2 buff如何生效***
    - 攻击时立即生效
        - 注意：在1对1攻击计算后会移除此类型 buff
    - 攻击后生效
        - 根据配置的生效顺序，生效点5/1/2依次生效，之后其他生效点 buff 再生效
    - 结算后才生效
        - 攻击后不会生效，等 buff 结算时才爆开生效
    - 特殊：攻击过程外添加的 buff，一般都是立即生效
        - 比如常驻 buf、受击加 buff、死亡加 buff 等等许多时机

- ***3.3 神将流程***
    - 神将流程指的是神将新加机制的实现
    - 注意：
        - 尽量做成通用逻辑，不要只适用于特定神将
        - 注意服务器与客户端逻辑的统一
    - 主要包含哪些处理
        - 受击处理
        - 死亡处理
        - 血量比在某区间段的处理
        - 宠物行动值的处理
        - 血量保底、复活等处理
        - 必杀连携、buff 转移、替补上场、目标锁定等处理
___

### 4. 战斗异常解决
- **什么是战斗异常？**
    - 为了防止外挂，服务器对战斗是有校验机制的  
    - 但如果是因为服务器、客户端战斗逻辑不统一，服务器也可能校验失败
      > 解决战斗异常指的是解决双方战斗逻辑不统一的问题

- **解决战斗异常的前提**
    - 要定位异常点，必现战斗异常是前提，所以逆向战斗是必不可少的
    - 逆向战斗
        - 由战斗数据逆向为原始的卡牌数据、或怪物数据等等，重新初始化战斗，即可重现战斗
        - 战斗保存需保存随机数，逆向战斗会用到
          > 保存随机数种子，自定义随机算法。或者保存所用到的随机数。
    - 战斗日志
      > 由于异常是上报数据校验失败导致，所以对重点战斗过程（特别是校验环节）需要有日志打印，可方便定位问题

- **如何解决战斗异常？**
    - 熟悉服务器战斗日志所有内容是如何打印的
    - 对于简单的战斗异常，可通过查看日志定位问题
    - 对于复杂的战斗异常，需要服务器和客户端联调，定位哪部分逻辑不一致

- **战斗异常率维持在什么水平是能接受的？**
    - 异常率超过千分之5：  很危险，必须紧急提取外网数据解决
    - 异常率在千分之3到千分之5之间： 有点危险，在工作不忙时考虑解决
    - 异常率在千分之1到千分之3之间：能接受
    - 异常率在万分之几：比较乐观
      > 现在异常率已经降低到万分之5左右
___
